<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportZone - Admin Dashboard</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h2><i class="fas fa-dumbbell"></i> SportZone</h2>
                <p class="admin-info">Admin: <span id="adminEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="accdc8c1c5c2ecdfdcc3ded8d6c3c2c982cfc3c1">[email&#160;protected]</a></span></p>
            </div>
            <nav class="sidebar-nav">
                <a href="#overview" class="nav-item active" onclick="showSection('overview')">
                    <i class="fas fa-tachometer-alt"></i> T·ªïng quan
                </a>
                <a href="#products" class="nav-item" onclick="showSection('products')">
                    <i class="fas fa-box"></i> S·∫£n ph·∫©m
                </a>
                <a href="#orders" class="nav-item" onclick="showSection('orders')">
                    <i class="fas fa-shopping-cart"></i> ƒê∆°n h√†ng
                </a>
                <a href="#users" class="nav-item" onclick="showSection('users')">
                    <i class="fas fa-users"></i> Ng∆∞·ªùi d√πng
                </a>
                <a href="#logout" class="nav-item logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Success Banner -->
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <strong>ƒêƒÉng nh·∫≠p th√†nh c√¥ng!</strong>
                Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi trang qu·∫£n tr·ªã SportZone. H·ªá th·ªëng ƒë√£ ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.
            </div>

            <!-- System Status -->
            <div class="status-bar">
                <span class="status-item">
                    <i class="fas fa-circle status-dot"></i>
                    Tr·∫°ng th√°i: <span class="status-text">K·∫øt n·ªëi database OK | Auth: Ho·∫°t ƒë·ªông | UI: Loaded</span>
                </span>
            </div>

            <!-- Overview Section -->
            <div id="overview" class="content-section active">
                <h1>Admin Dashboard</h1>
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3>DOANH THU</h3>
                            <p class="stat-number" id="totalRevenue">0 ‚Ç´</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="stat-info">
                            <h3>ƒê∆†N H√ÄNG</h3>
                            <p class="stat-number" id="totalOrders">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>KH√ÅCH H√ÄNG</h3>
                            <p class="stat-number" id="totalUsers">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info">
                            <h3>S·∫¢N PH·∫®M</h3>
                            <p class="stat-number" id="totalProducts">0</p>
                        </div>
                    </div>
                </div>

                <!-- System Activity -->
                <div class="activity-section">
                    <h3><i class="fas fa-chart-line"></i> Ho·∫°t ƒë·ªông h·ªá th·ªëng</h3>
                    <div class="activity-log" id="activityLog">
                        <p><i class="fas fa-play"></i> Running full system test...</p>
                        <p><i class="fas fa-check"></i> Authentication: OK</p>
                        <p><i class="fas fa-check"></i> Supabase client: OK</p>
                        <p><i class="fas fa-database"></i> Testing database connection...</p>
                        <p><i class="fas fa-check"></i> Supabase client available</p>
                        <p><i class="fas fa-chart-bar"></i> Statistics updated successfully</p>
                        <p><i class="fas fa-chart-bar"></i> Statistics updated successfully</p>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="products" class="content-section">
                <h1>Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
                <div class="section-content">
                    <button class="btn btn-primary">
                        <i class="fas fa-plus"></i> Th√™m s·∫£n ph·∫©m m·ªõi
                    </button>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>T√™n s·∫£n ph·∫©m</th>
                                    <th>Gi√°</th>
                                    <th>T·ªìn kho</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <tr>
                                    <td colspan="6" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders" class="content-section">
                <h1>Qu·∫£n l√Ω ƒê∆°n h√†ng</h1>
                <div class="section-content">
                    <div class="filter-bar">
                        <select class="form-control">
                            <option>T·∫•t c·∫£ ƒë∆°n h√†ng</option>
                            <option>Ch·ªù x·ª≠ l√Ω</option>
                            <option>ƒê√£ x√°c nh·∫≠n</option>
                            <option>ƒêang giao</option>
                            <option>Ho√†n th√†nh</option>
                            <option>ƒê√£ h·ªßy</option>
                        </select>
                        <input type="date" class="form-control">
                    </div>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>M√£ ƒë∆°n</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>Ng√†y ƒë·∫∑t</th>
                                    <th>T·ªïng ti·ªÅn</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTable">
                                <tr>
                                    <td colspan="6" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users" class="content-section">
                <h1>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h1>
                <div class="section-content">
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>H·ªç t√™n</th>
                                    <th>Ng√†y ƒëƒÉng k√Ω</th>
                                    <th>Vai tr√≤</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td colspan="7" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="js/supabase.js"></script>
    <script>
        // üîê AUTH GUARD - Ki·ªÉm tra ƒëƒÉng nh·∫≠p ngay khi load trang
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Starting auth check...');
            
            // Ki·ªÉm tra session trong localStorage
            const userSession = localStorage.getItem('userSession');
            console.log('üîé Checking session:', userSession);
            
            if (!userSession) {
                console.log('‚ùå No session found, redirecting to login...');
                alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                window.location.href = 'admin-login-debug.html';
                return;
            }
            
            try {
                const session = JSON.parse(userSession);
                console.log('‚úÖ Session parsed:', session);
                
                if (!session.email || !session.role) {
                    console.log('‚ùå Invalid session data, redirecting...');
                    localStorage.removeItem('userSession');
                    window.location.href = 'admin-login-debug.html';
                    return;
                }
                
                // C·∫≠p nh·∫≠t th√¥ng tin admin tr√™n UI
                const adminEmailElement = document.getElementById('adminEmail');
                if (adminEmailElement) {
                    adminEmailElement.textContent = session.email;
                }
                
                console.log('‚úÖ Auth check passed, initializing admin dashboard...');
                
                // Kh·ªüi t·∫°o dashboard
                initializeDashboard();
                
            } catch (error) {
                console.error('‚ùå Error parsing session:', error);
                localStorage.removeItem('userSession');
                window.location.href = 'admin-login-debug.html';
                return;
            }
        });

        // üìä Kh·ªüi t·∫°o dashboard
        async function initializeDashboard() {
            console.log('üöÄ Initializing dashboard...');
            
            try {
                // Test k·∫øt n·ªëi Supabase
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase client not available');
                }
                
                console.log('‚úÖ Supabase client available');
                
                // Load statistics
                await loadStatistics();
                
                // Load initial data cho c√°c section
                await loadProducts();
                await loadOrders();
                await loadUsers();
                
                console.log('‚úÖ Dashboard initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Dashboard initialization error:', error);
                addActivityLog('‚ùå Dashboard initialization failed: ' + error.message);
            }
        }

        // üìà Load th·ªëng k√™
        async function loadStatistics() {
            try {
                console.log('üìä Loading statistics...');
                
                // Simulate loading statistics (thay th·∫ø b·∫±ng real API calls)
                const stats = {
                    revenue: 0,
                    orders: 0,
                    users: 1, // Admin account
                    products: 0
                };
                
                // Update UI
                document.getElementById('totalRevenue').textContent = stats.revenue.toLocaleString('vi-VN') + ' ‚Ç´';
                document.getElementById('totalOrders').textContent = stats.orders;
                document.getElementById('totalUsers').textContent = stats.users;
                document.getElementById('totalProducts').textContent = stats.products;
                
                addActivityLog('üìä Statistics updated successfully');
                
            } catch (error) {
                console.error('Error loading statistics:', error);
                addActivityLog('‚ùå Failed to load statistics: ' + error.message);
            }
        }

        // üõçÔ∏è Load products
        async function loadProducts() {
            try {
                console.log('üì¶ Loading products...');
                const tbody = document.getElementById('productsTable');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</td></tr>';
                addActivityLog('üì¶ Products loaded');
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // üõí Load orders
        async function loadOrders() {
            try {
                console.log('üìã Loading orders...');
                const tbody = document.getElementById('ordersTable');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                addActivityLog('üìã Orders loaded');
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // üë• Load users
        async function loadUsers() {
            try {
                console.log('üë• Loading users...');
                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = `
                    <tr>
                        <td>1</td>
                        <td>admin@sportzone.com</td>
                        <td>System Admin</td>
                        <td>2025-09-16</td>
                        <td><span class="badge badge-danger">Super Admin</span></td>
                        <td><span class="badge badge-success">Active</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary">Edit</button>
                        </td>
                    </tr>
                `;
                addActivityLog('üë• Users loaded');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // üìù Add activity log
        function addActivityLog(message) {
            const activityLog = document.getElementById('activityLog');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('vi-VN');
            
            const logEntry = document.createElement('p');
            logEntry.innerHTML = `<i class="fas fa-info-circle"></i> [${timeStr}] ${message}`;
            activityLog.appendChild(logEntry);
            
            // Keep only last 10 entries
            const entries = activityLog.querySelectorAll('p');
            if (entries.length > 10) {
                entries[0].remove();
            }
        }

        // üîÑ Navigation functions
        function showSection(sectionId) {
            console.log(`üìÇ Switching to section: ${sectionId}`);
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active to clicked nav
            event.target.closest('.nav-item').classList.add('active');
            
            addActivityLog(`üìÇ Switched to ${sectionId} section`);
        }

        // üö™ Logout function
        function logout() {
            console.log('üö™ Logging out...');
            
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('userSession');
                addActivityLog('üö™ User logged out');
                alert('ƒêƒÉng xu·∫•t th√†nh c√¥ng!');
                window.location.href = 'admin-login-debug.html';
            }
        }

        // üîß Test functions
        window.testConnection = async function() {
            try {
                console.log('üîß Testing database connection...');
                addActivityLog('üîß Testing database connection...');
                
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase client not available');
                }
                
                // Test basic connection
                const { data, error } = await supabase.from('users').select('count');
                
                if (error) {
                    throw error;
                }
                
                addActivityLog('‚úÖ Database connection test successful');
                console.log('‚úÖ Database connection test successful');
                
            } catch (error) {
                console.error('‚ùå Database connection test failed:', error);
                addActivityLog('‚ùå Database connection test failed: ' + error.message);
            }
        };
    </script>
</body>
</html>
